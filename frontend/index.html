<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QuotexAI Pro — Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container py-4">
    <h1 class="h4 mb-3">QuotexAI Pro — Admin (Vercel)</h1>

    <div class="card mb-3">
      <div class="card-body">
        <div class="row g-2">
          <div class="col-sm-6">
            <input id="backendUrl" class="form-control" placeholder="Backend Base URL (Render) e.g., https://quotex-ai-pro.onrender.com" />
          </div>
          <div class="col-sm-6">
            <input id="adminKey" class="form-control" placeholder="Admin API Key" />
          </div>
          <div class="col-12">
            <button id="btnLoad" class="btn btn-primary">Load Stats & Users</button>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-3 mb-3">
      <div class="col-md-4">
        <div class="card h-100"><div class="card-body">
          <div class="small text-muted">Total Users</div>
          <div id="statTotal" class="h4">-</div>
        </div></div>
      </div>
      <div class="col-md-4">
        <div class="card h-100"><div class="card-body">
          <div class="small text-muted">Active Premium</div>
          <div id="statPremium" class="h4">-</div>
        </div></div>
      </div>
      <div class="col-md-4">
        <div class="card h-100"><div class="card-body">
          <div class="small text-muted">New Today</div>
          <div id="statNew" class="h4">-</div>
        </div></div>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-header">Actions</div>
      <div class="card-body">
        <div class="row g-2 align-items-end">
          <div class="col-md-4"><input id="ident" class="form-control" placeholder="Telegram ID or Email"></div>
          <div class="col-md-2"><input id="days" type="number" class="form-control" value="30"></div>
          <div class="col-md-2"><button id="btnGrant" class="btn btn-success w-100">Grant</button></div>
          <div class="col-md-2"><button id="btnRevoke" class="btn btn-warning w-100">Revoke</button></div>
          <div class="col-md-2"><button id="btnReload" class="btn btn-secondary w-100">Reload</button></div>
        </div>
        <div class="row g-2 mt-2">
          <div class="col-md-10"><input id="msgText" class="form-control" placeholder="Message text"></div>
          <div class="col-md-2"><button id="btnMsg" class="btn btn-outline-primary w-100">Send DM</button></div>
        </div>
        <div class="row g-2 mt-2">
          <div class="col-md-10"><input id="bcText" class="form-control" placeholder="Broadcast to premium users"></div>
          <div class="col-md-2"><button id="btnBC" class="btn btn-primary w-100">Broadcast</button></div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">Users</div>
      <div class="table-responsive">
        <table class="table table-sm table-striped mb-0">
          <thead>
            <tr>
              <th>Telegram ID</th>
              <th>Name</th>
              <th>Email</th>
              <th>Premium</th>
              <th>Expiry</th>
              <th>Last Login</th>
            </tr>
          </thead>
          <tbody id="usersBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const q = sel => document.querySelector(sel);
    const headers = () => ({ 'x-admin-key': q('#adminKey').value.trim(), 'content-type': 'application/json' });

    async function loadAll() {
      const base = q('#backendUrl').value.trim();
      if (!base) return;
      const [stats, users] = await Promise.all([
        fetch(base + '/api/stats', { headers: headers() }).then(r => r.json()),
        fetch(base + '/api/users', { headers: headers() }).then(r => r.json())
      ]);
      q('#statTotal').textContent = stats.total_users ?? '-';
      q('#statPremium').textContent = stats.active_premium ?? '-';
      q('#statNew').textContent = stats.new_signups_today ?? '-';
      const body = q('#usersBody');
      body.innerHTML = '';
      (users.users || []).forEach(u => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${u.telegram_id ?? ''}</td><td>${u.name ?? ''}</td><td>${u.email ?? ''}</td><td>${u.is_premium ? '✅' : '❌'}</td><td>${u.expires_at ?? ''}</td><td>${u.last_login ?? ''}</td>`;
        body.appendChild(tr);
      });
    }

    async function post(path, payload) {
      const base = q('#backendUrl').value.trim();
      const r = await fetch(base + path, { method: 'POST', headers: headers(), body: JSON.stringify(payload) });
      return r.json();
    }

    q('#btnLoad').onclick = loadAll;
    q('#btnReload').onclick = loadAll;
    q('#btnGrant').onclick = async () => { await post('/api/grant', { ident: q('#ident').value, days: Number(q('#days').value) }); loadAll(); };
    q('#btnRevoke').onclick = async () => { await post('/api/revoke', { ident: q('#ident').value }); loadAll(); };
    q('#btnMsg').onclick = async () => { await post('/api/message', { ident: q('#ident').value, text: q('#msgText').value }); };
    q('#btnBC').onclick = async () => { await post('/api/broadcast', { text: q('#bcText').value }); };
  </script>
</body>
</html>
